# MiniMessenger (Double Ratchet + псевдо-PQ KEM, CLI)

Невеликий навчальний прототип E2E-месенджера з консольною клієнтською програмою та простим асинхронним сервером-ретранслятором.  
Основні фічі:

- End-to-End шифрування на базі **Double Ratchet** (X448 + AES-HMAC).
- Окремий KEM-шар для ініціалізації сесії (зараз X448 як заглушка під майбутній **post-quantum KEM**).
- Реєстрація / логін із телефоном та display-name.
- Система інвайтів (`/invite`, `/invites`, `/accept`) з автоматичним запуском чату.
- Локальне збереження стану Double Ratchet та PQ-приватних ключів.

> ⚠ **Важливо:** це навчальний код, НЕ продакшн-рівень безпеки. Немає аудиту, захисту від side-channel атак, безпечного зберігання ключів, нормального KDF для паролів тощо. Використовувати тільки для експериментів.

---

## Структура проєкту

```text
signal/
├── .venv/               # локальне віртуальне середовище (можна не комітити)
├── pq_client_keys/      # локальні PQ-приватні ключі клієнтів (*.bin)
├── accounts.json        # база акаунтів на стороні сервера
├── client.py            # CLI-клієнт з Double Ratchet + PQ-KEM
├── client_config.json   # конфіг підключення клієнта (host/port)
├── crypto_config.py     # криптоконфіг: Double Ratchet + KEM API
└── server.py            # простий асинхронний сервер-ретранслятор
````


**Додаткові файли, які з’являються під час роботи:**

* `state_<user>_<peer>.json` — локальний стан Double Ratchet для кожного чату.
* `pq_client_keys/<user>.bin` — локальний приватний KEM-ключ конкретного
  користувача на конкретній машині.

---

## Вимоги

* Python **3.10+**

Пакети:

* `doubleratchet`
* `cryptography`

---

## Встановлення

### 1. Клонувати / скопіювати репозиторій

```bash
git clone <repo-url> signal
cd signal
```

### 2. Створити віртуальне середовище (рекомендовано)

```bash
python -m venv .venv

# Linux/macOS
source .venv/bin/activate

# Windows
.\.venv\Scripts\activate
```

### 3. Встановити залежності

```bash
pip install doubleratchet cryptography
```

### 4. Переконатись, що існує папка для PQ-ключів

```bash
mkdir -p pq_client_keys
```

---

## Конфігурація клієнта

Файл `client_config.json` задає параметри підключення до сервера:

```json
{
  "host": "127.0.0.1",
  "port": 9999
}
```

Якщо файл відсутній або зламаний, клієнт використовує `127.0.0.1:9999` за замовчуванням.

---

## Запуск сервера

В окремому терміналі:

```bash
python server.py
```

Сервер:

* слухає `0.0.0.0:9999`;
* завантажує/створює `accounts.json`;
* тримає карту онлайн-клієнтів і просто пересилає службові та зашифровані повідомлення.

---

## Запуск клієнта

В іншому терміналі (на тій же або іншій машині):

```bash
python client.py
```

Після запуску з’явиться CLI-меню.

Основні команди:

* `/help` — список команд.
* `/connect` — підключення до сервера та `signup/login`.
* `/me` — показати поточний користувач / статус.
* `/chats` — локальні чати (список файлів `state_*.json`).
* `/invite USER` — надіслати інвайт користувачу `USER`.
* `/invites` — подивитись, хто запросив вас у чат.
* `/accept USER` — прийняти інвайт від `USER` і зайти в чат як **responder**.
* `/chat USER` — відкрити чат з `USER` як **initiator**.
* `/disconnect` — розірвати з’єднання з сервером.
* `/quit` — вийти з клієнта.

---

## Типовий сценарій

1. Запустити сервер:

   ```bash
   python server.py
   ```

2. На двох різних терміналах запустити клієнт:

   ```bash
   python client.py
   ```

3. На кожному клієнті:

   * виконати `/connect`;
   * вибрати `signup`;
   * ввести `Username`, `Account password`, `Phone`, `Display name`.

4. На клієнті **A**:

   ```text
   cli> /invite B
   ```

5. На клієнті **B**:

   ```text
   cli> /invites
   cli> /accept A
   ```

6. Після прийняття інвайта клієнти проходять:

   * KEM-handshake (епфемерно-статичний X448 → `shared_secret`);
   * Double Ratchet-handshake поверх цього секрету.

7. В чаті можна писати звичайний текст.

   Доступні внутрішні команди:

   * `/help` — допомога;
   * `/profile` або `/profile USER` — показати профіль;
   * `/leave` — вийти з чату назад у `cli>`.

---

## Коротко про криптоконфіг

### Double Ratchet

* DH-рачети на X448 (`ChatDiffieHellmanRatchet`).
* `ChatRootChainKDF` — HKDF-SHA-512 для root-ланцюжка.
* `ChatMessageChainKDF` — окремі HMAC-ключі (SHA-512/256) для message-ланцюжка.
* AEAD (`ChatAEAD`) — AES + HMAC (SHA-512).

### KEM-шар (`pq_kem_*`)

* Інтерфейс як у post-quantum KEM.
* Зараз всередині також X448 + HKDF-SHA-512 (епфемерно-статичний DH).
* Публічний ключ акаунта зберігається на сервері в `accounts.json`.
* Приватний ключ зберігається локально у `pq_client_keys/<user>.bin`.

---

## Обмеження та попередження безпеки

* Немає захисту від крадіжки файлів `state_*.json` та `pq_client_keys/*.bin`.
* Паролі хешуються через SHA-256 без солі (лише для демо).
* Немає forward-секретності для облікових записів сервера.
* KEM-шар не є справжнім post-quantum — це X448, обгорнутий у KEM-API.

Цей репозиторій призначений для **навчання** (розбір Double Ratchet, KEM-handshake,
інвайт-системи та побудови простого CLI-месенджера). Для реального продакшну
потрібен повний крипто-дизайн, аудит і заміна KEM на справжнє PQ-рішення.

```
::contentReference[oaicite:0]{index=0}
```
